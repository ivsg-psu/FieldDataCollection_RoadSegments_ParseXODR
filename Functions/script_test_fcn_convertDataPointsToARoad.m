% This script works to write the xodr file for test track, using the data
% points exported from scenario CAD design
% For details, please see fcn_convertDataPointsToARoad.m
% Author: Wushuang
% Revision history:
% 20230503 first write of the code
% 20230505 complete updating geometry
% 20230512 added comments
% 20230601 added test cases

clear;clc;close all;

%% Case 1, test track
% Hard coded test track data points
data1 = [
    -77.83409119799995,40.86251254700005,0
    -77.83108116099999,40.86426763900005,0
    ];


data2 = [
    -77.83211176999998,40.86579081600007,0
    -77.83556504299997,40.86504032700003,0
    ];

data3 = [
    -77.83108116099999,40.86426763900005,0
    -77.83098509099995,40.86432365200005,0
    -77.83093857199998,40.86435301300003,0
    -77.83087253399998,40.86439877000004,0
    -77.83080882499996,40.86444684500003,0
    -77.83075077399997,40.86449883100005,0
    -77.83069596999997,40.86455288200005,0
    -77.83064856399994,40.86461089600004,0
    -77.83060707999994,40.86467151800008,0
    -77.83057291199998,40.86473474700006,0
    -77.83054614799994,40.86479999100004,0
    -77.83052443199995,40.86486635700004,0
    -77.83051053899999,40.86493399600005,0
    -77.83050385699994,40.86500232600008,0
    -77.83050469499995,40.86507096000003,0
    -77.83051096999998,40.86513880700005,0
    -77.83051548199995,40.86516167900004,0
    -77.83052813799998,40.86520696400004,0
    -77.83055303799995,40.86527300500006,0
    -77.83058410099994,40.86533739600003,0
    -77.83062308399997,40.86539921800005,0
    -77.83066833899994,40.86545839100006,0
    -77.83071974699999,40.86551445800006,0
    -77.83077704999994,40.86556697700007,0
    -77.83084030799995,40.86561520700008,0
    -77.83090661499995,40.86566081200004,0
    -77.83097722599996,40.86570252900003,0
    -77.83105323399997,40.86573830000003,0
    -77.83113270799998,40.86576916300004,0
    -77.83121508099998,40.86579495800004,0
    -77.83129931099995,40.86581674200005,0
    -77.83138581099996,40.86583237300005,0
    -77.83147340899995,40.86584355000008,0
    -77.83156186599996,40.86584960200003,0
    -77.83165067999994,40.86585007100007,0
    -77.83173939599999,40.86584604200004,0
    -77.83182788999994,40.86583809200005,0
    -77.83191641299999,40.86582709200007,0
    -77.83198191299994,40.86581637600005,0
    -77.83211176999998,40.86579081600007,0
    ];

data4 = [
    -77.83409119799995,40.86251254700005,0
    -77.83428682199997,40.86240212100006,0
    -77.83438618499997,40.86234856900006,0
    -77.83446087699997,40.86231037400006,0
    -77.83453749299997,40.86227440000005,0
    -77.83461641299994,40.86224136900006,0
    -77.83469677099998,40.86221027000005,0
    -77.83477921099995,40.86218235500007,0
    -77.83486324199998,40.86215698400008,0
    -77.83494914399995,40.86213491900003,0
    -77.83503585099999,40.86211543200005,0
    -77.83512406099999,40.86209993300002,0
    -77.83521303499998,40.86208681600004,0
    -77.83530322699994,40.86207687100006,0
    -77.83539479299998,40.86207085300003,0
    -77.83548423999997,40.86206892000007,0
    -77.83557547099997,40.86207004900007,0
    -77.83566529499996,40.86207398600004,0
    -77.83575727099998,40.86207915200004,0
    -77.83584689699995,40.86208980200007,0
    -77.83593554399994,40.86210511700006,0
    -77.83602658799998,40.86212333200007,0
    -77.83610896799996,40.86214451600006,0
    -77.83619562999996,40.86216812400005,0
    -77.83627940899999,40.86219488800003,0
    -77.83636222199993,40.86222624600003,0
    -77.83644048299999,40.86225870300007,0
    -77.83651749499995,40.86229581800006,0
    -77.83659255999999,40.86233323900007,0
    -77.83666548199994,40.86237558700003,0
    -77.83673544899995,40.86241920700007,0
    -77.83680129099997,40.86246548400004,0
    -77.83686645999995,40.86251478800006,0
    -77.83692662799996,40.86256500800005,0
    -77.83698470399997,40.86261750800003,0
    -77.83703933999999,40.86267213900004,0
    -77.83709037099999,40.86272870800008,0
    -77.83713808899995,40.86278688300007,0
    -77.83718242699996,40.86284655800006,0
    -77.83722280899997,40.86290781300005,0
    -77.83725846399994,40.86297070600006,0
    -77.83729063399994,40.86303462000006,0
    -77.83732025099994,40.86309922700008,0
    -77.83734393399999,40.86316522200008,0
    -77.83736427099996,40.86323181000006,0
    -77.83737978299996,40.86329911100006,0
    -77.83739059599998,40.86336689000007,0
    -77.83739891699997,40.86343482100006,0
    -77.83740297699995,40.86350296900008,0
    -77.83740316699993,40.86357118600006,0
    -77.83739827399995,40.86363929500004,0
    -77.83739047999995,40.86370724600005,0
    -77.83738026599997,40.86377509000005,0
    -77.83736676099994,40.86384272800007,0
    -77.83734681499999,40.86390947900003,0
    -77.83732344899994,40.86397564800006,0
    -77.83729424899997,40.86404048600008,0
    -77.83726199099993,40.86410450300008,0
    -77.83722550399995,40.86416722600006,0
    -77.83718422199996,40.86422821400004,0
    -77.83713948699994,40.86428776900004,0
    -77.83709042299995,40.86434530600008,0
    -77.83703489299995,40.86439933300005,0
    -77.83697710299998,40.86445173400006,0
    -77.83691780699996,40.86450297800008,0
    -77.83685631599997,40.86455265500007,0
    -77.83679220199997,40.86460038400003,0
    -77.83672550299997,40.86464605800006,0
    -77.83665658199999,40.86468987400008,0
    -77.83658492099994,40.86473117400004,0
    -77.83651050599997,40.86476964800005,0
    -77.83643301199999,40.86480446300004,0
    -77.83635336599997,40.86483632900007,0
    -77.83627108899998,40.86486400900003,0
    -77.83618827499998,40.86489060000008,0
    -77.83610436099997,40.86491526600003,0
    -77.83601880199996,40.86493658400008,0
    -77.83556504299997,40.86504032700003,0
    ];

data4 = flipud(data4);
data = [data3;data4];
LL_centerline = fliplr(data(:,1:2));
% define start line
startLine = [ 40.8655035,-77.83071141];
% reorder the data by start line
startLineInd = knnsearch(LL_centerline(:,[1,2]),startLine);
LL_centerline = [LL_centerline(startLineInd:end,:);LL_centerline(1:startLineInd-1,:)];

% add elevation
LL_centerline(:,3) = 333.817;
% convert to ENU
reference_LLA = [40.86368573, -77.83592832, 344.189];
ENUdata = fcn_GPS_lla2enu(LL_centerline,reference_LLA);


%% case 1, test track data points
case1 = fcn_convertDataPointsToARoad(ENUdata);

%% case 2, sample path from path class library
fig_num = 33;
single_path = fcn_Path_fillSamplePaths(4) * 100; % multiply by 100 to get a road with practical length
traversal = fcn_Path_convertPathToTraversalStructure(single_path);
case2 = fcn_convertDataPointsToARoad(single_path);






